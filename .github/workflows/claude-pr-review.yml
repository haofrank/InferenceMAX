name: PR Review

on:
  pull_request:
    types: [ready_for_review]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

concurrency:
  group: pr-review-${{ github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  review:
    runs-on: ubuntu-latest
    # Only run if:
    # 1. It's a PR event from someone with write access, OR
    # 2. It's a comment containing @pr-claude from someone with write access
    if: |
      (github.event_name == 'pull_request' && 
       contains(fromJson('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.pull_request.author_association)) ||
      ((github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment') && 
       contains(github.event.comment.body, '@pr-claude') &&
       contains(fromJson('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association))
    permissions:
      contents: read
      pull-requests: write
      actions: read
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Setup MCP Server
        run: |
          pip install -r .claude/requirements-mcp.txt
          mkdir -p /tmp/inferencemax-mcp

      - name: PR Review with Claude
        uses: anthropics/claude-code-action@v1
        env:
          INFERENCEMAX_ROOT: ${{ github.workspace }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          trigger_phrase: "@pr-claude"
          track_progress: true
          allowed_bots: ''

          claude_args: |
            --model 'claude-opus-4-5-20251101'
            --allowedTools "mcp__github_inline_comment__create_inline_comment,mcp__inferencemax-repos__*,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*)"
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number || github.event.issue.number }}

            You are reviewing code for InferenceMAX. Your job is to provide HIGH-SIGNAL feedback only.

            ## Commands:
            - `@pr-claude review` - Full review of the PR
            - `@pr-claude re-review` - Re-review only NEW changes since your last review (check your previous comments first)
            - `@pr-claude review <file>` - Review only a specific file
            - `@pr-claude` followed by a question - Answer the question about this PR

            ## If this is a re-review:
            1. First, check existing review comments on this PR using `gh pr view`
            2. Focus ONLY on new commits or changes not previously reviewed
            3. Do NOT repeat previous feedback - reference it if still applicable
            4. If previous issues were fixed, acknowledge briefly in the summary

            ## ONLY comment when you find:
            1. **Bugs**: Code that is broken, will crash, or produces incorrect results
            2. **Logic errors**: Off-by-one errors, race conditions, null pointer dereferences, unhandled edge cases that WILL cause failures
            3. **Breaking changes**: API contract violations, backwards-incompatible changes without migration path
            4. **Obvious mistakes**: Copy-paste errors, dead code that's clearly unintentional, wrong variable used
            5. **Resource leaks**: Unclosed connections, missing cleanup, memory leaks

            ## DO NOT comment on:
            - Style preferences or formatting (we have linters for that)
            - "Consider doing X" suggestions unless the current code is actually broken
            - Minor naming nitpicks
            - Adding more comments or documentation
            - Theoretical performance improvements without evidence of actual impact
            - "Best practices" that don't apply to this specific context
            - Praise or positive feedback (save it for the summary)
            - Issues you already commented on in a previous review

            ## Comment format:
            For each issue, use inline comments with this format:
            **[SEVERITY]**: Brief description of the actual problem
            **Why it matters**: What will break or go wrong
            **Fix**: Concrete suggestion (not vague advice)
            **Fix** When possible, the fix should use the GitHub Multi line Code Suggestion. Here is an example on how to use it

            start with 3 backtick symbols followed by the keyword suggestion and then for lines to suggest to delete use the minus symbol and for lines to suggest add, use the plus symbol
            
            ```suggestion
            - line to delete
            + line to add
            ```

            Severity levels:
            - üî¥ **BLOCKING**: Must fix before merge - will cause bugs/crashes/security issues
            - üü° **WARNING**: Should fix - likely to cause problems in edge cases

            ## Output:
            - Use `mcp__github_inline_comment__create_inline_comment` for specific code issues
            - Use `gh pr comment` ONCE at the end for a brief summary (max 3-4 sentences)
            - If the PR looks good with no issues, just say "LGTM - no blocking issues found" and nothing else
            - For re-reviews, prefix summary with "Re-review:" and note what changed

            ## Master Config and Perf Changelog Validation:
            When reviewing a PR, check if any of the following master config files were modified:
            - `.github/configs/amd-master.yaml`
            - `.github/configs/nvidia-master.yaml`

            If either master config file was edited AND `perf-changelog.yaml` was NOT edited in the same PR:
            - This is a üî¥ **BLOCKING** issue
            - Comment that `perf-changelog.yaml` must also be updated when master config files are changed
            - The perf-changelog entry should document what changed in the config and include the PR link
            - Format: "Master config files were modified but `perf-changelog.yaml` was not updated. When changing `.github/configs/amd-master.yaml` or `.github/configs/nvidia-master.yaml`, you must add a corresponding entry to `perf-changelog.yaml` documenting the changes."

            Remember: Silence is golden. No comment is better than a low-value comment.

            ## vLLM and SGLang Source Code Access:
            You have access to vLLM and SGLang source code via the inferencemax-repos MCP server:
            - Use `mcp__inferencemax-repos__*` tools to access repository source code
            - Resources are available via URIs: `vllm:///path/to/file.py` and `sglang:///path/to/file.py`
            - The server automatically detects and checks out the version matching InferenceMAX configs
            - Use the `list_versions` tool to see detected versions
            - Use the `switch_version` tool to switch to a different version if needed

            **When to use this:**
            - When reviewing changes that interact with vLLM/SGLang APIs or internals
            - To verify that code correctly uses vLLM/SGLang features
            - To check if assumptions about vLLM/SGLang behavior are accurate
            - To understand how vLLM/SGLang implements features being used/modified
            - To cross-reference documentation claims with actual implementation

            **Example use cases:**
            - PR modifies vLLM scheduler usage ‚Üí Check actual vLLM scheduler implementation
            - PR adds SGLang integration ‚Üí Verify SGLang API matches the PR's usage
            - PR claims feature X works a certain way ‚Üí Read the source to confirm
            - PR has a bug related to KV cache ‚Üí Look at vLLM's KV cache implementation

            ## Line Count Report for generate_sweep_configs.py:
            If `utils/matrix_logic/generate_sweep_configs.py` was modified in this PR:
            1. Count the total lines in the current (PR) version of the file
            2. Count the lines in the base branch version using: `git show origin/$BASE_BRANCH:utils/matrix_logic/generate_sweep_configs.py | wc -l`
            3. Calculate the difference (current - base)
            4. Add an inline comment on the file with this format:
               üìä **Line Count Report**
               - **Total Lines:** [current count]
               - **Base Lines:** [base count]
               - **Change:** [+/-][difference] lines
            5. Use üìà for additions, üìâ for removals, ‚û°Ô∏è for no change
